# 模块说明

项目主要由以下几个核心模块组成：

## 1. Epoller

**职责：**  
封装 `epoll_create`, `epoll_ctl`, `epoll_wait`，提供 RAII 风格接口，简化 epoll 使用。

**主要功能：**

- 创建和销毁 epoll fd
- 添加 / 修改 / 删除监听的 fd
- 等待并返回就绪事件列表

---

## 2. Connection

**职责：**  
管理单个客户端连接的整个生命周期，并维护与该连接相关的所有状态。

**包含内容：**

- socket fd
- 读缓冲区 / 写缓冲区
- 协议解析状态机
- 最近活跃时间（用于超时剔除）
- 对应的 KVStore 操作入口

**关键逻辑：**

- 当 fd 可读时，从 socket 读取到读缓冲区
- 调用协议解析函数，将完整请求解析为命令
- 调用 KVStore 执行业务逻辑，生成响应
- 写响应到写缓冲区，注册可写事件，等待发送

---

## 3. KVStore

**职责：**  
管理内存中的 KV 数据，并提供持久化能力。

**实现方式：**

- 使用 `std::map<std::string, std::string>` 存储键值对
- 提供 `Get(key)` / `Set(key, value)` 等接口
- 提供 `Load(filename)` / `Save(filename)` 实现文件读写

**持久化策略：**

- 服务器启动时自动 `Load` 快照文件
- 接收到退出信号后自动 `Save` 当前内存数据

---

## 4. Reactor / Server 主循环

**职责：**  
作为整个服务器的大脑，负责：

- 初始化监听 socket
- 注册 epoll 事件
- 驱动事件循环不断处理就绪事件
- 定期执行定时任务（清理空闲连接）

**处理逻辑大致为：**

- 监听 fd：接受新连接，并创建 Connection
- 普通 fd：
  - 可读 → 调用 Connection 的读处理
  - 可写 → 调用 Connection 的写处理
- 定时任务：检查连接空闲时间，超时则关闭并回收

---

## 5. 定时器（如有实现）

**职责：**

- 定期遍历所有连接，找出超时的连接
- 释放资源，避免大量空闲连接占用文件描述符

可以使用简单的容器 + 时间戳来实现，也可以扩展为小根堆时间轮等更复杂结构。

---

通过以上模块划分，项目将 **网络 IO、连接管理、协议解析、业务逻辑、持久化** 等职责拆分得比较清晰，便于维护与扩展。
